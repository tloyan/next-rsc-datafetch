# Form : Validation Client / Serveur

### ğŸ’¡ Comprendre la validation Client Serveur avec RHF

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Nous avons vu la validation des champs cÃ´tÃ© client avec `React Hook Form` et `Zod`. Cela fonctionne bien mais en dÃ©sactivant `JavaScript` dans le navigateur, quelquâ€™un pourrait soumettre nâ€™importe quelle donnÃ©e. VoilÃ  pourquoi il est impÃ©ratif dâ€™avoir une validation cÃ´tÃ© serveur. Câ€™est aussi ce que nous avons fait avec un formulaire et `useActionState`. Mais la validation serveur prend du temps, ce qui rend lâ€™expÃ©rience utilisateur moins agrÃ©able.

Nous allons ici combiner les 2 approches.

- `React Hook Form`/ `Zod` pour la validation client.
- `useActionState`/ Validation `Zod` server.
- Et nous allons implÃ©menter des rÃ¨gles spÃ©cifiques et gÃ©rer des erreurs cÃ´tÃ© serveur.

Avec RHF, il est possible de spÃ©cifier manuellement les erreurs comme cela. Exemple sur le champs `title` :

```tsx
form.setError('title', {type: 'manual', message: 'le titre nest pas bon'})
```

Nous allons donc devoir retourner 2 types dâ€™erreurs :

- Les erreurs liÃ©es aux champs : Une liste dâ€™erreurs avec message du serveur action.
- Les erreurs non liÃ©es aux champs.

```tsx
type ValidationError = {
  field: keyof FormSchemaType
  message: string
}

export type FormState = {
  success: boolean
  errors?: ValidationError[]
  message?: string
}
export async function onSubmitAction(
  prevState: FormState,
  data: FormData
```

## Exercice

Le point de dÃ©part de lâ€™exercice est le formulaire `React Hook Form` avec la validation client de lâ€™exercice prÃ©cÃ©dent, avec un appel server action `persistProduct`.

```tsx
//rappel de la signature de l'action
type FormStateSimple = {error: boolean; message: string}

export async function onSubmitAction(
  prevState: FormStateSimple,
  data: FormData
```

**ğŸ¶** Dans un premier temps, adapte lâ€™action en utilisant les nouveaux types `ValidationError` et `FormState` dans lâ€™action. Retourne toutes les erreurs `zod` grÃ¢ce Ã  :

```tsx
if (!parsed.success) {
parsed.error.errors.map(....
```

ğŸ¶ Dans un second temps, adapte le formulaire pour gÃ©rer ces erreurs.

Fichiers

- `exercise/shop-admin/form/use-action-state.tsx`
- `exercise/shop-admin/action.tsx`

## Bonus

### 1. ğŸš€ Gestion du isPending (useFormStatus)

Dans les exercices prÃ©cÃ©dents, nous avons vu que `useActionState` peut sâ€™utiliser de pair avec `useFormStatus`. Cela nous permettait de dÃ©sactiver le bouton durant la soumission

```tsx
const Buttons = () => {
  const status = useFormStatus()
  return (
    <>
      <Button size="sm" type="submit" disabled={status.pending}>
        Save
      </Button>
      <Button size="sm" variant="outline">
        Cancel
      </Button>
    </>
  )
}
```

Essaie dâ€™utiliser cette mÃ©thode et constate que cela ne fonctionne pas. Cela est dÃ» en fait que le formulaire nâ€™est pas gÃ©rÃ© de maniÃ¨re non contrÃ´lÃ©e avec une `action` (comme exercice prÃ©cÃ©dent)

```tsx
<form
  action={formAction}
>
```

**ğŸ¶** Dans cet exercice, tu vas devoir gÃ©rer lâ€™Ã©tat de soumission avec un state `isPending`

```tsx
const [isPending, setIsPending] = React.useState(false)
```

- Lors de la soumission : `setIsPending(true)`
- Lors de la mise Ã  jour du state de `useActionForm` â†’ `setIsPending(false)`
- Utilise ce state pour `disable` le buton

Fichiers

- `exercise/shop-admin/form/use-action-state.tsx`

### 2. ğŸš€ GÃ©rer des erreurs custom server

ğŸ‘¨â€âœˆï¸ Hugo, le chef de projet, te demande maintenant de gÃ©rer 2 nouvelles erreurs custom.

1. Hugo te demande de valider que le champ `â€˜titleâ€™` ne contient pas 2 espaces.

   **ğŸ¤–** Utilise le code ci dessous :

   ```tsx
   **data.get('title')?.toString().includes('  ')**
   ```

2. Hugo te demande dâ€™interdire lâ€™insertion en double des donnÃ©es en base de donnÃ©es. Pour cela il te fournit une fonction `getProductByName` qui rÃ©cupÃ¨re un produit en fonction de son nom :

```tsx
const prod = await getProductByName(data.get('title')?.toString() ?? '')
if (prod) { ...
```

- ğŸ¶ Si le nom du produit contient 2 espaces consÃ©cutifs, retourne un message dâ€™erreur sur le champ `â€˜titleâ€™` `â€˜Custom server error : Title must not contain 2 spacesâ€™`
- ğŸ¶ Si le produit existe dÃ©jÃ , retourne un message dâ€™erreur sur le champ `title` `â€˜Product al0ready existsâ€™`

Fichiers

- `exercise/shop-admin/action.tsx`

## Aller plus loin

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=03.RSC%20Data%20fetch&entry.533578441=09%20Validation%20Client%20Server).
