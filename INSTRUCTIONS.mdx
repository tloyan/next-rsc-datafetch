# Optimistic UI

### ğŸ’¡ Comprendre les UI optimistes et le hook `useOptimistic`

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Lorsque nous faisons des appels vers le serveur (comme dans le cas des server actions), il peut y avoir un certain dÃ©lai. Ce dÃ©lai rend lâ€™expÃ©rience utilisateur non fluide. Pour gÃ©rer cela, on peut ajouter des `progress bars`, `spinner` ou tout autre Ã©lÃ©ment indiquant quâ€™un chargement est en cours. Mais cela reste encore pas optimisÃ© pour lâ€™expÃ©rience utilisateur. Il existe une technique :

L'**Optimistic UI** (Interface Utilisateur Optimiste) est une technique de conception d'interfaces utilisateur oÃ¹ les changements d'Ã©tat sont immÃ©diatement reflÃ©tÃ©s dans l'interface, avant mÃªme que le serveur n'ait confirmÃ© ces changements. Cette approche vise Ã  amÃ©liorer l'expÃ©rience utilisateur en rendant l'application plus rÃ©active et fluide, en rÃ©duisant la latence perÃ§ue.

### **Principe de fonctionnement**

1. **Action utilisateur** : Lorsqu'un utilisateur effectue une action (comme soumettre un formulaire ou cliquer sur un bouton), l'application met immÃ©diatement Ã  jour l'interface pour reflÃ©ter cette action.
2. **RequÃªte au serveur** : ParallÃ¨lement, une requÃªte est envoyÃ©e au serveur pour effectuer l'opÃ©ration demandÃ©e.
3. **RÃ©ponse du serveur** :
   - **SuccÃ¨s** : Si la requÃªte est rÃ©ussie, l'interface reste telle qu'elle.
   - **Ã‰chec** : Si la requÃªte Ã©choue, l'application doit gÃ©rer l'erreur en restaurant l'Ã©tat prÃ©cÃ©dent ou en affichant un message d'erreur.

### `React` a introduit un Hook pour gÃ©rer cela **`useOptimistic`**

```tsx
import { useOptimistic } from 'react';

function AppContainer() {
  const [optimisticState, addOptimistic] = useOptimistic(
    state,
    // updateFn (un reducer)
    (currentState, optimisticValue) => {
      // merge and return new state
      // with optimistic value
    }
  );
```

ğŸ“‘ Le lien vers la doc [https://react.dev/reference/react/useOptimistic](https://react.dev/reference/react/useOptimistic)

## Exercice

Dans la gestion cÃ´tÃ© backend des listes de tÃ¢ches, il peut y avoir des ralentissements ou des erreurs (nous simulons cela avec la config de `sgbd.ts`).

```tsx
const randomError = true
const slowConnexion = true
const serverResponseTime = 2000
```

ğŸ‘¨â€âœˆï¸ Hugo, le chef de projet, te demande dâ€™implÃ©menter une approche `*optimistic UI*` pour la gestion des tÃ¢ches pour que lâ€™interface soit rÃ©active et gÃ¨re les cas dâ€™erreurs.

Dans `todos-view`, adapte le code en utilisant le hook `useOptimisic`.

Fichiers

- `exercises/todos/todos-view.tsx`

## Bonus

### 1. ğŸš€ API StartTransition

Lorsque des actions longues sont exÃ©cutÃ©es, lâ€™UI est bloquante, câ€™est a dire que la mise Ã  jour (`render`) nâ€™est pas effectuÃ©e tant que lâ€™action longue nâ€™est pas terminÃ©e. Il existe un Hook `useTransition` qui permet de gÃ©rer cela.

- Exemple ici : [https://19.react.dev/reference/react/useTransition#examples](https://19.react.dev/reference/react/useTransition#examples)

Il existe aussi lâ€™API `startTransition`

- ğŸ“‘ Documentation [https://19.react.dev/reference/react/startTransition](https://19.react.dev/reference/react/startTransition)

Dans notre cas, nous avons une action longue : lâ€™appel au server action `await AddTodoAction(newTodo)`.

Et nous changeons un `state` avec `addOptimisticTodo(newTodo)`. Du coup nous avons un warning :

```tsx
Warning: An optimistic state update occurred outside a transition or action. To fix, move the update to an action, or wrap with startTransition.
```

ğŸ‘¨â€âœˆï¸ Hugo, le Chef de projet, te demande de gÃ©rer correctement ce cas pour ne plus avoir de warning.

**ğŸ¶ Wrap le `addOptimisticTodo(newTodo)` et lâ€™appel au server action dans un `startTransition`**

Fichiers

- `exercises/todos/todos-view.tsx`

### 2. ğŸš€ useOptimistic with optimistic values

Dans cet exercice, nous voulons gÃ©rer une mise Ã  jour dâ€™une tÃ¢che (`isCompleted`) et nous souhaitons Ã©galement avoir un indicateur de chargement (un lÃ©ger effet animation sur le texte).

Nous avons une classe `tailwind` pour cela `animate-color-cycle` voir `tailwind.config.ts 'color-cycleâ€™`

```tsx
<label
  className={cn('flex-1 text-sm font-medium', {
    'line-through': optimisticTodo.isCompleted, //ligne barrÃ©e
    'animate-color-cycle': optimisticTodo.sending, //animation chargement
  })}
  htmlFor={`${optimisticTodo.id}`}
>
```

Les valeurs `â€œoptimiticâ€` dont nous aurons besoin sont :

- `isCompleted`
- `sending`

De telle maniÃ¨re que nous puissions utiliser :

```tsx
const handleChange = async (isCompleted: boolean) => {
    updateOptimisticTodo({isCompleted, sending: true})
    try {
      await updateTodoAction({
        ...todo,
        isCompleted,
      })
    } catch (error) {
      toast.error(`Failed to update todo.${error}`)
    } finally {
      updateOptimisticTodo({isCompleted, sending: false})
    }
  }
```

Dans le cas prÃ©cis, nous nâ€™utilisons pas un type `Todo` car nous avons un champs supplÃ©mentaire (`sending`) .

De plus, contrairement Ã  lâ€™exemple prÃ©cÃ¨dent oÃ¹ `lâ€™optimistic value` Ã©tait un objet `Todo` Ã  ajouter au state, ici il sâ€™agit de 2 propriÃ©tÃ©s `{isCompleted, sending}`.

Pour typer correctement le hook `useOptimistic<TypeDuState, TypeOptmisticValue>` tu peux utiliser ces 2 types dans le code.

```tsx
type TodoOptimistic = Todo & {
  sending?: boolean
} //TypeDuState : un Todo + sending

type OptimisticFields = {isCompleted: boolean; sending: boolean} //TypeOptmisticValue
//car l'appel est
//updateOptimisticTodo({isCompleted, sending: false})
```

ğŸ¶ Dans cet exercice tu vas devoir :

1. Dans un premier temps, crÃ©er et typer correctement le hook `useOptimistic` en utilisant les 2 types ci-dessus :

```tsx
const [optimisticTodo, updateOptimisticTodo] = useOptimistic<...>
```

1. Appeler `updateOptimisticTodo({isCompleted, sending})` avant et aprÃ¨s lâ€™appel au server action.
2. Wrapper le tout dans `startTransition`.
3. Utiliser `optimisticTodo` partout (Ã  la place de `todo`).
4. Ajouter `'animate-color-cycle` sur le label.

Fichiers

- `exercises/todos/todo-item.tsx`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=03.RSC%20Data%20fetch&entry.533578441=06%20Optimistic%20UI).
